package mydev.za; import mydev.vutils.Data; import mydev.vutils.Ester; import mydev.vutils.Spiska; public class Zetupka { final static boolean D=false; Spiska lines; public Zetupka() { super(); this.lines=new Spiska();} public boolean isReadyFork() { if(hasLine(LineType.TypeFiles0)) return false; if(hasLine(LineType.TypeEE)) return false; if(hasLine(LineType.TypeItems)) return false; if(!(hasLine(LineType.TypeFiles) && hasLine(LineType.TypeMezto))) return false; return true;} public Zetupka loadLines(String content) { Ester curLine=new Ester(""); int lineNum=0; for(int i=0; i < content.length(); i++) { char ch=content.charAt(i); if(ch=='\n') { lines.append(new ZetupkaLine(++lineNum,curLine)); curLine=new Ester("");} else curLine.append(ch);} return this;} public String ambu(String content) { loadLines(content); transformLines(); Ester result=new Ester(""); for(int i=0; i < lines.size(); i++) { ZetupkaLine line=(ZetupkaLine) lines.at(i); if(Zetupka.D) result.append(line.repr()).append('\n'); else result.append(line.getContent()).append('\n');} return result.toString();} void transformLines() { if(hasLine(LineType.TypeFiles0) && hasLine(LineType.TypeItems)) apply(new ZeroFilesRule(this)); if(hasLine(LineType.TypeEE)) apply(new EELineRule(this)); if(hasLine(LineType.TypeEmpty)) apply(new ReduceEmptiesRule(this)); if(hasLine(LineType.TypeEmpty)) apply(new RemoveLastEmptyRule(this)); if(hasCustomLine(LineType.TypeFiles,"es= vutils.bat")) apply(new RemoveDoubleVutilsRule(this));} private void apply(ZetupkaTransformRule rule) { rule.apply();} boolean hasLine(LineType type) { for(int i=0; i < lines.size(); i++) { ZetupkaLine line=(ZetupkaLine) lines.at(i); if(line.kindOf(type)) return true;} return false;} public ZetupkaLine get(LineType type) { for(int i=0; i < lines.size(); i++) { ZetupkaLine line=(ZetupkaLine) lines.at(i); if(line.kindOf(type)) return line;} return null;} public void replace(ZetupkaLine itemsLine,LineType newLineType) { for(int i=0; i < lines.size(); i++) { ZetupkaLine line=(ZetupkaLine) lines.at(i); if(line.getNumber()==itemsLine.getNumber()) { line.transform(newLineType); return;}}} public void replace(ZetupkaLine files0Line,LineType newLineType,Ester content) { for(int i=0; i < lines.size(); i++) { ZetupkaLine line=(ZetupkaLine) lines.at(i); if(line.getNumber()==files0Line.getNumber()) { line.transform(newLineType,content); return;}}} public boolean hasCustomLine(LineType type,String pattern) { for(int i=0; i < lines.size()-1; i++) { ZetupkaLine line=(ZetupkaLine) lines.at(i); if(line.kindOf(type) && line.content.contains(new Ester(pattern))) return true;} return false;} public boolean hasDoubleLine(LineType type) { for(int i=0; i < lines.size()-1; i++) { ZetupkaLine line=(ZetupkaLine) lines.at(i); ZetupkaLine line2=(ZetupkaLine) lines.at(i+1); if(line.kindOf(type) && line2.kindOf(type)) return true;} return false;} public ZetupkaLine getDouble(LineType type) { for(int i=0; i < lines.size()-1; i++) { ZetupkaLine line=(ZetupkaLine) lines.at(i); ZetupkaLine line2=(ZetupkaLine) lines.at(i+1); if(line.kindOf(type) && line2.kindOf(type)) return line;} return null;} public void replace(ZetupkaLine zetupkaLine,LineType type,LineType type2) { if(zetupkaLine.kindOf(type) && zetupkaLine.kindOf(type2)) lines.remove(zetupkaLine);} public boolean hasLastLine(LineType type) { ZetupkaLine lastLine=(ZetupkaLine) lines.at(lines.size()-1); return lastLine.kindOf(type);} public void ommitLastLine(LineType type) { ZetupkaLine lastLine=(ZetupkaLine) lines.at(lines.size()-1); if(lastLine.kindOf(type)) lines.remove(lastLine);} public ZetupkaLine getCustomLine(LineType type,String pattern) { for(int i=0; i < lines.size()-1; i++) { ZetupkaLine line=(ZetupkaLine) lines.at(i); if(line.kindOf(type) && line.content.contains(new Ester(pattern))) return line;} return null;} public void removeDouble(ZetupkaLine zetupkaLine,LineType typefiles,LineType typemezto) { for(int i=0; i < lines.size()-1; i++) { ZetupkaLine line=(ZetupkaLine) lines.at(i); ZetupkaLine line2=(ZetupkaLine) lines.at(i+1); if(line.equals(zetupkaLine) && line.kindOf(typefiles) && line2.kindOf(typemezto)) { lines.remove(line); lines.remove(line2); return;}}}} class LineType { public final static LineType TypeFiles=new LineType(0,"<files>"); public final static LineType TypeFiles0=new LineType(0+1,"<files-0>"); public final static LineType TypeMezto=new LineType(1+1,"<mezto>"); public final static LineType TypeEE=new LineType(2+1,"<EE>"); public final static LineType TypeEmpty=new LineType(2+1+1,"<empty>"); public final static LineType TypeItems=new LineType(2+1+1+1,"<all items>"); private int id; private String descr; private LineType(int id,String descr) { this.id=id; this.descr=descr;} public int getId() { return id;} public String getDescr() { return descr;} public String getStrk() { return "K"+id;} public static LineType checkLineType(Ester content) { if(content.length() >= 2) { if(content.begins(new Ester("files=")) && content.length() <= new Ester("files=").length()+1+1+1) return TypeFiles0; if(content.begins(new Ester("files="))) return TypeFiles; if(content.begins(new Ester("mezto="))) return TypeMezto; if(content.begins(new Ester("EE"))) return TypeEE;} if(Data.replace(Data.replace(Data.replace(content,new Ester(" "),new Ester("")),new Ester("\t"),new Ester("")),new Ester("\r"),new Ester("")).length() < 1+1) return TypeEmpty; return TypeItems;}} class ZetupkaLine { int number; Ester content; LineType type; public ZetupkaLine(int number,Ester content) { super(); this.number=number; this.content=content; this.type=LineType.checkLineType(content);} public void transform(LineType newLineType,Ester newContent) { if(newLineType.getId()==LineType.TypeFiles.getId()) { this.content=new Ester("files=").append(' ').append(newContent); this.type=newLineType;}} public void transform(LineType newLineType) { this.content=new Ester(""); this.type=newLineType;} public boolean kindOf(LineType type2) { return type.getId()==type2.getId();} public int getNumber() { return number;} public Ester getContent() { return content;} public Ester repr() { Ester result=new Ester(""); result.append(number).append(") ").append(type.getDescr()).append(content); return result;} public String toString() { return repr().toString();}} interface ZetupkaTransformRule { void apply();} class RemoveLastEmptyRule implements ZetupkaTransformRule { Zetupka zetupka; public RemoveLastEmptyRule(Zetupka zetupka) { super(); this.zetupka=zetupka;} public void apply() { if(zetupka.hasLastLine(LineType.TypeEmpty)) zetupka.ommitLastLine(LineType.TypeEmpty);}} class ReduceEmptiesRule implements ZetupkaTransformRule { Zetupka zetupka; public ReduceEmptiesRule(Zetupka zetupka) { super(); this.zetupka=zetupka;} public void apply() { while(zetupka.hasDoubleLine(LineType.TypeEmpty)) { ZetupkaLine zetupkaLine=zetupka.getDouble(LineType.TypeEmpty); zetupka.replace(zetupkaLine,LineType.TypeEmpty,LineType.TypeEmpty);}}} class RemoveDoubleVutilsRule implements ZetupkaTransformRule { Zetupka zetupka; public RemoveDoubleVutilsRule(Zetupka zetupka) { super(); this.zetupka=zetupka;} public void apply() { while(zetupka.hasCustomLine(LineType.TypeFiles,"es= vutils.bat")) { ZetupkaLine zetupkaLine=zetupka.getCustomLine(LineType.TypeFiles,"es= vutils.bat"); zetupka.removeDouble(zetupkaLine,LineType.TypeFiles,LineType.TypeMezto);}}} class EELineRule implements ZetupkaTransformRule { Zetupka zetupka; public EELineRule(Zetupka zetupka) { super(); this.zetupka=zetupka;} public void apply() { while(zetupka.hasLine(LineType.TypeEE)) { ZetupkaLine zetupkaLine=zetupka.get(LineType.TypeEE); zetupka.replace(zetupkaLine,LineType.TypeEmpty);}}} class ZeroFilesRule implements ZetupkaTransformRule { Zetupka zetupka; public ZeroFilesRule(Zetupka zetupka) { super(); this.zetupka=zetupka;} public void apply() { ZetupkaLine files0Line=zetupka.get(LineType.TypeFiles0); ZetupkaLine itemsLine=zetupka.get(LineType.TypeItems); Ester items=itemsLine.getContent(); zetupka.replace(itemsLine,LineType.TypeEmpty); zetupka.replace(files0Line,LineType.TypeFiles,items);}}